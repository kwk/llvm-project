# This test ensures that two symbols with the same name are only merged if all
# of the following attributes are the same: symbol name, size, address/value,
# section name.

# RUN: yaml2obj %s > %t

# RUN: llvm-objcopy \
# RUN:   --redefine-sym=all_same2=all_same1 \
# RUN:   --redefine-sym=different_section2=different_section1 \
# RUN:   --redefine-sym=different_address2=different_address1 \
# RUN:   --redefine-sym=different_size2=different_size1 %t

# RUN: %lldb -b -o 'image dump symtab' %t | FileCheck %s

# CHECK: Index UserID DSX Type File Address/Value Load Address Size Flags Name
# CHECK:      [ 0] 1 Code 0x0000000000500000 0x0000000000000008 0x00000002 all_same1
# CHECK-NEXT: [ 1] 3 Code 0x0000000000500000 0x0000000000000008 0x00000002 different_section1
# CHECK-NEXT: [ 2] 4 Code 0x0000000000500000 0x0000000000000008 0x00000002 different_section1
# CHECK-NEXT: [ 3] 5 Code 0x0000000000500000 0x0000000000000008 0x00000002 different_address1
# CHECK-NEXT: [ 4] 6 Code 0x0000000000500001 0x0000000000000008 0x00000002 different_address1
# CHECK-NEXT: [ 5] 7 Code 0x0000000000500000 0x0000000000000008 0x00000002 different_size1
# CHECK-NEXT: [ 6] 8 Code 0x0000000000500000 0x0000000000000009 0x00000002 different_size1
# CHECK-EMPTY:

--- !ELF
FileHeader:
  Class:           ELFCLASS64
  Data:            ELFDATA2LSB
  Type:            ET_EXEC
  Machine:         EM_X86_64
  Entry:           0x0000000000400000
Sections:
  - Name:            .text
    Type:            SHT_PROGBITS
    Flags:           [ SHF_ALLOC, SHF_EXECINSTR ]
    Address:         0x0000000000400000
    AddressAlign:    0x0000000000000010
    Content:         DEADBEEFBAADF00D
  - Name:            .text2
    Type:            SHT_PROGBITS
    Flags:           [ SHF_ALLOC, SHF_EXECINSTR ]
    Address:         0x0000000000500000
    AddressAlign:    0x0000000000000010
    Content:         DEADBEEFBAADF00D
Symbols:
  # Symbols with same addresses, names, sizes but different sections
  - Name:            all_same1
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500000
    Size:            0x0000000000000008
    # Symbol all_same2 will be renamed to all_same1 and should therefore
    # disappear from the dumped symtab because all fields are equal.
  - Name:            all_same2
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500000
    Size:            0x0000000000000008
  # Symbols with same addresses, names, sizes and sections
  - Name:            different_section1
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500000
    Size:            0x0000000000000008
    # Symbol different_section2 will be renamed to different_section1 and we
    # should# see two symbols named different_section1 in the dumped symtab.
  - Name:            different_section2
    Type:            STT_FUNC
    Section:         .text2
    Value:           0x0000000000500000
    Size:            0x0000000000000008
  # Symbols with same names, sizes and sections but different addresses
  - Name:            different_address1
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500000
    Size:            0x0000000000000008
    # Symbol different_address2 will be renamed to different_address1 and we
   # should see two symbols named different_address1 in the dumped symtab.
  - Name:            different_address2
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500001
    Size:            0x0000000000000008
  # Symbols with same names, addresses and sections but different sizes
  - Name:            different_size1
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500000
    Size:            0x0000000000000008
    # Symbol different_size2 will be renamed to different_size1 and we should
    # see two symbols named different_size1 in the dumped symtab.
  - Name:            different_size2
    Type:            STT_FUNC
    Section:         .text
    Value:           0x0000000000500000
    Size:            0x0000000000000009
...
